# https://phelipetls.github.io/posts/introduction-to-ansible/
- name: Bootstrap a local environment
  hosts: localhost
  become: no
  vars:
    user_id: "{{ ansible_user_id }}"

  tasks:
  - name: Install required packages on Ubuntu
    become: yes
    apt:
      name:
        - git
        - curl
        - fish
        - ruby-dev
      state: present
    when: ansible_distribution == "Ubuntu"

  # Prepare symbolic links at first
  - name: Create symbolic links for a $HOME/.config directory
    file:
      src: "{{ playbook_dir }}/static/common/.config/{{ item }}"
      dest: "{{ ansible_env.HOME }}/.config/{{ item  }}"
      state: link
    loop:
      - fish
      - git
      - tmux

  - name: Create symbolic links for a $HOME/ directory
    file:
      src: "{{ playbook_dir }}/static/common/{{ item }}"
      dest: "{{ ansible_env.HOME }}/{{ item }}"
      state: link
    loop:
      - .composer
      - .ssh
      - bin
      - .editorconfig
      - .eslintrc.json
      - .gitconfig
      - .gitignore



  # Fish
  - name: Create a symbolic link for a $HOME/.config directory
    file:
      src: "{{ playbook_dir }}/static/common/.config/{{ item }}"
      dest: "{{ ansible_env.HOME }}/.config/{{ item  }}"
      state: link
    loop:
      - fish
  - name: Download a fisher
    get_url:
      url: https://git.io/fisher
      dest: "{{ ansible_env.HOME }}/.config/fish/functions/fisher.fish"
  - name: Download fish plugins
    command:
      cmd: fish -c "fisher update"

  ## Change the default shell to fish
  - name: Get fish command path
    command: "which fish"
    register: fish_command_path
  - set_fact:
      fish_command_path: "{{ fish_command_path.stdout }}"
  - debug:
      msg: "Fish command path is {{ fish_command_path }}"
  - name: Check if a /etc/shells contains fish
    become: true
    lineinfile:
      dest: /etc/shells
      line: "{{ fish_command_path }}"
      state: present
  - name: Change the default user shell to fish
    become: true
    user:
      name: "{{ user_id }}"
      shell: "{{ fish_command_path }}"



  # Install bundle for GitHub pages
  - name: Install bundle
    gem:
      name: bundler
      state: latest
